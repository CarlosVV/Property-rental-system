/*! app 29-04-2015 */
var rentalApp=angular.module("RentalApp",["ui.router","ngResource","uiGmapgoogle-maps","ngAutocomplete","ui.bootstrap.datetimepicker","angularFileUpload","highcharts-ng","ui.bootstrap","home","addProperty","login","register","logout","searchProperties","myBookings","showProperty","conversations","chat","myProperties","myProperty","myPropertyStatistics","updateProperty","myPropertyBookings","myPropertyUnavailableDates","PropertyServiceModule","BookingServiceModule","ConversationServiceModule","AccountServiceModule","BookingDatesDirective","DatepickerDirective","BookingStatusDirective","CheckListDirective","ValidateQueryDirective","GroupBookingsByDateDirective","SortingFilters","TruncateFilter","HttpInterceptorService"]);rentalApp.constant("API_URL","/propertyRental/api/"),rentalApp.constant("APP_URL","/propertyRental/"),rentalApp.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){b.otherwise("/"),c.interceptors.push("httpErrorResponseInterceptor")}]),rentalApp.run(["$rootScope","$state","ConversationService","$interval",function(a,b,c,d){a.isLoggedIn=function(){var a=null!==localStorage.getItem("currentUsername");return a},a.getAuthority=function(){return localStorage.getItem("authority")},a.currentUsername=localStorage.getItem("currentUsername"),a.isLoggedIn()&&(a.newMsgs=new c.conversation.query({},function(){console.log("OKAY WE GOT",a.newMsgs),a.newMsgs.length&&a.$broadcast("newMessages")}));d(function(){a.isLoggedIn()&&(a.newMsgs=new c.conversation.query({},function(){console.log("OKAY WE GOT",a.newMsgs),a.newMsgs.length&&a.$broadcast("newMessages")}))},5e3);a.$on("$stateChangeStart",function(c,d,e,f,g){a.pageTitle=d.data.pageTitle+" - Property rental system",console.log("WORKS?"),0!=d.data.authorities.length&&(a.isLoggedIn()&&-1==d.data.authorities.indexOf(a.getAuthority())?(c.preventDefault(),b.go("accessDenied")):a.isLoggedIn()||(a.returnToState=d,a.returnToStateParams=e,c.preventDefault(),b.go("login")))})}]);var addProperty=angular.module("addProperty",[]);addProperty.config(["$stateProvider",function(a){a.state("addProperty",{url:"/addProperty",views:{mainView:{templateUrl:"modules/addProperty/partials/addProperty.html",controller:"AddPropertyCtrl"}},data:{authorities:["ROLE_USER"],pageTitle:"Add property"}})}]),addProperty.controller("AddPropertyCtrl",["$scope","$timeout","$state","PropertyService","$upload","API_URL",function(a,b,c,d,e,f){function g(b){console.log(f+"properties/uploadPhoto"),b.progress=10,b.upload=e.upload({url:f+"properties/uploadPhoto",file:b}).progress(function(a){b.progress=Math.min(100,parseInt(100*a.loaded/a.total)),b.progressMsg=b.progress}).success(function(d,e,f,g){b.progress=100,b.progressMsg="Success",b.error=!1,console.log("file "+g.file.name+"uploaded. Response: "+d.success),a.property.imagePaths.push({path:d.success}),a.property.imagePaths.length==a.photosToUpload.length&&a.property.$save(function(a){c.go("showProperty",{propertyId:a.id})})}).error(function(a,c,d,e){b.progress=100,b.progressMsg="Error",b.error=!0})}a.property=new d.property,a.property.userAccount={username:localStorage.currentUsername},a.property.imagePaths=[],a.property.propertyFacilities=[],a.details={},a.propertyTypes=d.propertyTypes.query(),a.propertyFacilities=d.propertyFacilities.query(),a.photosToUpload=[],a.fileReaderSupported=null!=window.FileReader&&(null==window.FileAPI||0!=FileAPI.html5),a.steps=["Main details","Sizing","Description","Photos"],a.currentStep=0,a.hasNextStep=!0,a.hasPreviousStep=!1,a.nextStep=function(){a.goToStep(a.currentStep+1),a.hasNextStep=a.checkNextStep(),a.hasPreviousStep=a.checkPreviousStep()},a.previousStep=function(){a.goToStep(a.currentStep-1),a.hasPreviousStep=a.checkPreviousStep(),a.hasNextStep=a.checkNextStep()},a.goToStep=function(b){"undefined"!=typeof a.steps[b]&&(a.currentStep=b)},a.checkNextStep=function(){return"undefined"!=typeof a.steps[a.currentStep+1]?!0:!1},a.checkPreviousStep=function(){return"undefined"!=typeof a.steps[a.currentStep-1]?!0:!1},a.neededAddressComponents={locality:"long_name",administrative_area_level_1:"short_name",country:"long_name",postal_code:"long_name",route:"long_name",street_number:"long_name"},a.addressAssembler={locality:"city",administrative_area_level_1:"administrativeArea",country:"country",postal_code:"postalCode"},a.addressComponentsAssembler={route:"street",street_number:"street_number"},a.resetQuery=function(){console.log("RESETING"),a.property.city="",a.property.administrativeArea="",a.property.country="",a.property.postalCode="",a.streetNumber=""},a.$watch("address",function(b){"undefined"!=typeof a.address?""==a.address?(console.log("new Val is empty set to",a.addressBackup),a.address=a.addressBackup):(a.addressBackup=a.address,console.log("newVal is ok",a.addressBackup)):(console.log("pls",a.addressBackup),a.address=a.addressBackup)}),a.$watch("details",function(b){if("undefined"!=typeof b.address_components){for(var c="",d="",e=0;e<b.address_components.length;e++){var f=b.address_components[e].types[0];a.neededAddressComponents[f]&&("street"==a.addressComponentsAssembler[f]?c=b.address_components[e][a.neededAddressComponents[f]]:"street_number"==a.addressComponentsAssembler[f]?d=" "+b.address_components[e][a.neededAddressComponents[f]]:a.property[a.addressAssembler[f]]=b.address_components[e][a.neededAddressComponents[f]])}a.streetNumber=d,console.log("SRSLY",a.streetNumber),a.property.address=c+d,a.marker.coords.latitude=b.geometry.location.k,a.marker.coords.longitude=b.geometry.location.D,a.map.center.latitude=b.geometry.location.k,a.map.center.longitude=b.geometry.location.D,a.map.zoom=16,a.property.latitude=b.geometry.location.k,a.property.longitude=b.geometry.location.D,console.log(a.property.address),console.log(a.marker.coords.latitude),console.log(a.marker.coords.longitude),console.log(a.property.postalCode),console.log(a.property.administrativeArea)}}),a.autoCompleteOptions={watchEnter:!1},a.map={center:{latitude:0,longitude:0},zoom:8},a.marker={id:0,coords:{latitude:45,longitude:-73},options:{draggable:!0},events:{dragend:function(b,c,d){var e=b.getPosition().lat(),f=b.getPosition().lng();a.property.longitude=f,a.property.latitude=e,a.marker.options={draggable:!0,labelAnchor:"100 0",labelClass:"marker-labels"}}}},a.addProperty=function(){console.log("adding",a.property),a.uploadAndSave()},a.$watch("photos",function(b){if(console.log("WORKS?",b),null!=b)for(var c=0;c<b.length;c++)a.errorMsg=null,a.generateThumb(b[c]),a.photosToUpload.push(b[c])}),a.uploadAndSave=function(){if(a.photosToUpload&&a.photosToUpload.length)for(var b=0;b<a.photosToUpload.length;b++)console.log("UPLOADING",a.photosToUpload[b]),g(a.photosToUpload[b])},a.removePhoto=function(b){var c=a.photosToUpload.indexOf(b);console.log("SLICED",c),c>-1&&(a.photosToUpload.splice(c,1),console.log(a.photosToUpload))},a.generateThumb=function(c){null!=c&&a.fileReaderSupported&&c.type.indexOf("image")>-1&&b(function(){var a=new FileReader;a.readAsDataURL(c),a.onload=function(a){b(function(){c.dataUrl=a.target.result})}})},a.addPropertyButtonDisabled=function(b){return b.$valid&&a.property.propertyFacilities.length>0&&a.photosToUpload.length>0?!1:!0}}]);var chat=angular.module("chat",[]);chat.config(["$stateProvider",function(a){a.state("conversations.chat",{url:"/{bookingId}",templateUrl:"modules/conversations/partials/chat.html",controller:"ChatCtrl",data:{authorities:["ROLE_USER"]}})}]),chat.controller("ChatCtrl",["$scope","ConversationService","$stateParams","$rootScope",function(a,b,c,d){a.message={},a.currentBooking={},a.messages=new b.conversation.query({bookingId:c.bookingId},function(){d.newMsgs.length&&angular.forEach(d.newMsgs,function(a){a.bookingId==c.bookingId&&b.conversation.markRead({bookingId:a.bookingId})})}),a.$on("newMessages",function(){if(console.log("THANK YOU"),d.newMsgs.length){for(var e=!1,f=0;f<d.newMsgs.length;f++)d.newMsgs[f].bookingId==c.bookingId&&(a.messages.push(d.newMsgs[f]),d.newMsgs.splice(f,1),e=!0,f--);e&&b.conversation.markRead({bookingId:c.bookingId})}}),a.$watchGroup(["bookingsStatuses","myBookings","myPropertiesBookings",function(){if(!angular.isUndefined(a.bookingsStatuses)&&!angular.isUndefined(a.myBookings)&&!angular.isUndefined(a.myPropertiesBookings)){var b=!1;angular.forEach(a.myBookings,function(d){d.bookingId==c.bookingId&&(a.currentBooking=d,b=!0)}),b||angular.forEach(a.myPropertiesBookings,function(b){b.bookingId==c.bookingId&&(a.currentBooking=b)})}}]),a.sendMessage=function(d){var e=!1;angular.forEach(a.myBookings,function(b){b.bookingId==c.bookingId&&(a.message.receiverUsername=b.propertyAccountUsername,e=!0)}),e||angular.forEach(a.myPropertiesBookings,function(b){b.bookingId==c.bookingId&&(a.message.receiverUsername=b.userAccountUsername)}),a.message.bookingId=c.bookingId,a.message.senderUsername=localStorage.getItem("currentUsername"),b.conversation.save({},a.message,function(b){console.log("answer from server:",b),a.messages.push(b),a.message={},d.$setPristine()})}}]);var conversations=angular.module("conversations",[]);conversations.config(["$stateProvider",function(a){a.state("conversations",{"abstract":!0,url:"/conversations",views:{mainView:{templateUrl:"modules/conversations/partials/conversations.html",controller:"ConversationsCtrl"}},data:{authorities:["ROLE_USER"],pageTitle:"Conversations"}}).state("conversations.pleaseSelect",{url:"",templateUrl:"modules/conversations/partials/pleaseSelect.html",data:{authorities:["ROLE_USER"]}})}]),conversations.controller("ConversationsCtrl",["$scope","BookingService","$rootScope","$stateParams",function(a,b,c,d){a.myBookings=new b.booking.myBookings(function(){console.log(a.myBookings)}),a.bookingsStatuses=new b.bookingsStatuses.query,a.myPropertiesBookings=new b.booking.allMyPropertiesBookings,a.newMsgsAvailable=function(a){for(var b=0;b<c.newMsgs.length;b++)if(c.newMsgs[b].bookingId==a)return!0;return!1}}]);var home=angular.module("home",[]);home.config(["$stateProvider",function(a){a.state("home",{url:"/",views:{mainView:{templateUrl:"modules/home/partials/home.html",controller:"HomeController"}},data:{authorities:[],pageTitle:"Home"}})}]),home.controller("HomeController",["$scope","PropertyService","$state","$filter","AccountService",function(a,b,c,d,e){a.neededAddressComponents={locality:"long_name",administrative_area_level_1:"short_name",country:"long_name"},a.addressAssembler={locality:"city",administrative_area_level_1:"administrativeArea",country:"country"},a.$watch("query.checkIn",function(b){console.log("NEW VAL CHECKIN:",a.query.checkIn)}),a.query={},a.details={},a.autoCompleteOptions={watchEnter:!1},a.$watch("details",function(b){if("undefined"!=typeof b.address_components){a.query.city="",a.query.administrativeArea="",a.query.country="";for(var c=0;c<b.address_components.length;c++){var d=b.address_components[c].types[0];a.neededAddressComponents[d]&&(a.query[a.addressAssembler[d]]=b.address_components[c][a.neededAddressComponents[d]])}}console.log("query: ",a.query)}),a.queryProperties=function(){console.log("sending",d("date")(a.query.checkIn,"dd/MM/yyyy")),c.go("queryProperties",{address:a.query.address,country:a.query.country,city:a.query.city,admArea:a.query.administrativeArea,checkIn:d("date")(a.query.checkIn,"dd/MM/yyyy"),checkOut:d("date")(a.query.checkOut,"dd/MM/yyyy"),guestNumber:a.query.guestNumber})},a.resetQuery=function(){console.log("execute pls"),a.query.city="",a.query.administrativeArea="",a.query.country="",console.log(a.query.city)},a.beforeRender=function(a,b,c,d,e){for(var f=0;f<b.length;f++){var g=moment(b[f].utcDateValue);moment().diff(g,"days")>0&&(b[f].selectable=!1)}}}]);var myBookings=angular.module("myBookings",[]);home.config(["$stateProvider",function(a){a.state("showMyBookings",{url:"/showMyBookings",views:{mainView:{templateUrl:"modules/myBookings/partials/showMyBookings.html",controller:"ShowMyBookingsCtrl"}},data:{authorities:["ROLE_USER"],pageTitle:"My bookings"}})}]),myBookings.controller("ShowMyBookingsCtrl",["$scope","BookingService","$filter",function(a,b,c){a.currentPage=1,a.itemsPerPage=2,a.showOnlyStatus="",a.showOnlyYear="",a.availableYears=[],a.bookings=new b.booking.myBookings(function(){for(var b=0;b<a.bookings.length;b++){for(var c=moment(a.bookings[b].bookedDate).year(),d=!1,e=0;e<=a.availableYears.length;e++)a.availableYears[e]==c&&(d=!0);d||a.availableYears.push(c)}{var f=(a.currentPage-1)*a.itemsPerPage;f+a.itemsPerPage}a.filteredBookings=a.bookings}),a.bookingsStatuses=b.bookingsStatuses.query(),a.$watch("showOnlyStatus",function(){a.currentPage=1,a.filteredBookings=c("filter")(a.bookings,a.showOnlyStatus),a.filteredBookings=c("sortByYearBooking")(a.filteredBookings,a.showOnlyYear)}),a.$watch("showOnlyYear",function(){a.currentPage=1,a.filteredBookings=c("sortByYearBooking")(a.bookings,a.showOnlyYear),a.filteredBookings=c("filter")(a.filteredBookings,a.showOnlyStatus)})}]);var myProperties=angular.module("myProperties",[]);myProperties.config(["$stateProvider",function(a){a.state("showMyProperties",{"abstract":!0,url:"/showMyProperties",views:{mainView:{templateUrl:"modules/myProperties/partials/propertyList.html",controller:"ShowMyPropertiesCtrl"}},data:{authorities:["ROLE_USER"],pageTitle:"My properties"}}).state("showMyProperties.pleaseSelect",{url:"",templateUrl:"modules/myProperties/partials/pleaseSelect.html",data:{authorities:["ROLE_USER"]}})}]),myProperties.controller("ShowMyPropertiesCtrl",["$scope","PropertyService","BookingService",function(a,b,c){a.properties=b.property.findMyProperties(function(){console.log("HMMM",a.properties);for(var b=moment(),c=0;c<a.properties.length;c++){var d=moment(a.properties[c].createdDate).year();a.properties[c].availableYears=[];for(var e=b.year()-d,f=0;e>=f;f++)a.properties[c].availableYears.push(d+f)}})}]);var myProperty=angular.module("myProperty",[]);myProperty.config(["$stateProvider",function(a){a.state("showMyProperties.detail",{url:"/{propertyId}",templateUrl:"modules/myProperties/partials/details.html",controller:"ShowMyPropertyCtrl",data:{authorities:["ROLE_USER"]}})}]),myProperty.controller("ShowMyPropertyCtrl",["$scope","PropertyService","BookingService","$stateParams",function(a,b,c,d){a.$parent.selectedPropertyId=d.propertyId,console.log("CURRENT ID:",d.propertyId),a.currentProperty={},a.$watch("properties",function(){for(var b=0;b<a.properties.length;b++)if(a.properties[b].id==d.propertyId){a.currentProperty=a.properties[b];break}},!0)}]);var myPropertyBookings=angular.module("myPropertyBookings",[]);myPropertyBookings.config(["$stateProvider",function(a){a.state("showMyProperties.detail.bookings",{url:"/bookings",templateUrl:"modules/myProperties/partials/bookings.html",controller:"ShowMyPropertyBookingsCtrl",data:{authorities:["ROLE_USER"]}})}]),myPropertyBookings.controller("ShowMyPropertyBookingsCtrl",["$scope","PropertyService","BookingService","$stateParams","$filter",function(a,b,c,d,e){a.availableYears=[],a.currentPage=1,a.itemsPerPage=2,a.showOnlyStatus="",a.showOnlyYear="",a.propertyBookings=c.booking.myPropertiesBookings({propertyId:d.propertyId},function(){for(var b=0;b<a.propertyBookings.length;b++){for(var c=moment(a.propertyBookings[b].bookedDate).year(),d=!1,e=0;e<=a.availableYears.length;e++)a.availableYears[e]==c&&(d=!0);d||a.availableYears.push(c)}a.filteredBookings=a.propertyBookings}),a.bookingsStatuses=c.bookingsStatuses.query(),a.lastActionBookingId,a.lastStatus,a.setBookingStatusPayed=function(b){for(var d,e,f=0;f<a.propertyBookings.length;f++)a.propertyBookings[f].bookingId==b&&(d=b,e=f);null!=d&&null!=e&&(a.lastStatus=a.propertyBookings[e].bookingStatusId,c.bookingsStatuses.updateBookingStatus({bookingId:b,statusId:2},function(){a.propertyBookings[e].bookingStatusId=2}),a.lastActionBookingId=b)},a.cancelBooking=function(b){for(var d,e,f=0;f<a.propertyBookings.length;f++)a.propertyBookings[f].bookingId==b&&(d=b,e=f);null!=d&&null!=e&&(a.lastStatus=a.propertyBookings[e].bookingStatusId,c.bookingsStatuses.updateBookingStatus({bookingId:b,statusId:3},function(){a.propertyBookings[e].bookingStatusId=3}),a.lastActionBookingId=b)},a.annulLastAction=function(b){if(a.lastActionBookingId==b&&null!=a.lastStatus){for(var d,e=0;e<a.propertyBookings.length;e++)a.propertyBookings[e].bookingId==b&&(currentBookingId=b,d=e);c.bookingsStatuses.updateBookingStatus({bookingId:b,statusId:a.lastStatus},function(){a.propertyBookings[d].bookingStatusId=a.lastStatus,a.lastActionBookingId=0,a.lastStatus=0})}},a.$watch("showOnlyStatus",function(){a.currentPage=1,a.filteredBookings=e("filter")(a.propertyBookings,a.showOnlyStatus),a.filteredBookings=e("sortByYearBooking")(a.filteredBookings,a.showOnlyYear)}),a.$watch("showOnlyYear",function(){a.currentPage=1,a.filteredBookings=e("filter")(a.propertyBookings,a.showOnlyStatus),a.filteredBookings=e("sortByYearBooking")(a.filteredBookings,a.showOnlyYear)})}]);var myPropertyStatistics=angular.module("myPropertyStatistics",[]);myPropertyStatistics.config(["$stateProvider",function(a){a.state("showMyProperties.detail.statistics",{url:"/statistics",templateUrl:"modules/myProperties/partials/statistics.html",controller:"ShowMyPropertyStatisticsCtrl",data:{authorities:["ROLE_USER"]}})}]),myPropertyStatistics.controller("ShowMyPropertyStatisticsCtrl",["$scope","PropertyService","BookingService","$stateParams",function(a,b,c,d){a.bookedDaysYear=moment().year(),a.avgGuestCountYear=moment().year(),a.avgStarsYear=moment().year(),a.avgBookingsLengthYear=moment().year(),a.showPropertyBookedDays=function(b){a.propertyBookedDays=new c.propertyBookedDays.query({id:d.propertyId,year:b},function(){for(var b=[],c=0;c<a.propertyBookedDays.length;c++){var d=moment([a.bookedDaysYear,a.propertyBookedDays[c].month-1]).format("MMMM YYYY");b.push([d,a.propertyBookedDays[c].bookedDays])}console.log(b),a.chartConfigBookedDays={options:{title:{text:"Amount of booked days by months"}},series:[],xAxis:{title:{text:"Months"},categories:[]}},a.chartConfigBookedDays.series.push({name:"Booked days",data:b}),console.log(a.propertyBookedDays),a.showChart=!0})},a.showPropertyAvgGuestCount=function(b){a.propertyAvgGuestCount=new c.propertyAvgBookingGuestCount.query({id:d.propertyId,year:b},function(){for(var b=[],c=0;c<a.propertyAvgGuestCount.length;c++){var d=moment([a.avgGuestCountYear,a.propertyAvgGuestCount[c].month-1]).format("MMMM YYYY");b.push([d,a.propertyAvgGuestCount[c].averageGuestCount])}a.chartConfigAvgGuestCount={options:{title:{text:"Average guest count by months"}},series:[],xAxis:{title:{text:"Months"},categories:[]}},a.chartConfigAvgGuestCount.series.push({name:"Average guest count",data:b})})},a.showPropertyAvgStars=function(b){a.propertyAvgStars=new c.propertyAvgStars.query({id:d.propertyId,year:b},function(){for(var b=[],c=0;c<a.propertyAvgStars.length;c++){var d=moment([a.avgStarsYear,a.propertyAvgStars[c].month-1]).format("MMMM YYYY");b.push([d,a.propertyAvgStars[c].averageStars])}a.chartConfigAvgStars={options:{title:{text:"Property average rating by months"}},series:[],xAxis:{title:{text:"Months"},categories:[]}},a.chartConfigAvgStars.series.push({name:"Property average rating",data:b})})},a.showBookingsAvgLength=function(b){a.bookingsAvgLength=new c.propertyAvgBookingLength.query({id:d.propertyId,year:b},function(){for(var b=[],c=[],d=0;d<a.bookingsAvgLength[0].bookingAvgLengthByMonth.length;d++){var e=moment([a.avgBookingsLengthYear,a.bookingsAvgLength[0].bookingAvgLengthByMonth[d].month-1,10]).valueOf();b.push([e,a.bookingsAvgLength[0].bookingAvgLengthByMonth[d].averageLength]),c.push([e,a.bookingsAvgLength[0].bookingCountByMonth[d].bookingCount])}a.chartConfigAvgBookingLength={series:[],options:{chart:{zoomType:"x"},rangeSelector:{enabled:!1},navigator:{enabled:!1}},xAxis:{title:{text:"Months"},type:"datetime",dateTimeLabelFormats:{month:"%b %Y"}},title:{text:"Average bookings length and number of bookings by months"},useHighStocks:!0},a.chartConfigAvgBookingLength.series.push({id:1,name:"Booking avg length",data:b,dataGrouping:{approximation:"sum",enabled:!0,forced:!0,units:[["month",[1]]]}},{id:2,name:"Booking count",data:c,dataGrouping:{approximation:"sum",enabled:!0,forced:!0,units:[["month",[1]]]}})})},a.showPropertyBookedDays(a.bookedDaysYear),a.showPropertyAvgGuestCount(a.avgGuestCountYear),a.showPropertyAvgStars(a.avgStarsYear),a.showBookingsAvgLength(a.avgBookingsLengthYear),a.$watch("bookedDaysYear",function(){console.log("DOES IT WORK?",a.bookedDaysYear)})}]);var myPropUnDates=angular.module("myPropertyUnavailableDates",[]);myPropUnDates.config(["$stateProvider",function(a){a.state("showMyProperties.detail.unDates",{url:"/unavailableDates",templateUrl:"modules/myProperties/partials/unavailableDates.html",controller:"UnavailableDatesCtrl",data:{authorities:["ROLE_USER"]}})}]),myPropUnDates.controller("UnavailableDatesCtrl",["$scope","PropertyService","BookingService","$stateParams",function(a,b,c,d){a.currentUnDates,a.currentBookedDates,a.datesUpdated=!0;var e;e=!0,a.datesUpdated=!0,a.currentUnDates=new c.onlyUnavailableDays.query({id:d.propertyId}),a.currentBookedDates=new c.onlyBookedDays.query({id:d.propertyId}),a.newUnDates,a.updateUnDates=function(b){e?e=!1:(a.newUnDates=b,a.datesUpdated=!1,a.$apply(),console.log("WHAT SCOPE OMG",a))},a.sendUnDates=function(){c.onlyUnavailableDays.update({id:d.propertyId},a.newUnDates,function(){a.datesUpdated=!0})}}]);var updateProperty=angular.module("updateProperty",[]);updateProperty.config(["$stateProvider",function(a){a.state("showMyProperties.detail.update",{url:"/update",templateUrl:"modules/myProperties/partials/updateProperty.html",controller:"UpdatePropertyCtrl",data:{authorities:["ROLE_USER"]}})}]),updateProperty.controller("UpdatePropertyCtrl",["$scope","PropertyService","$stateParams","API_URL","$timeout","$upload","$state",function(a,b,c,d,e,f,g){function h(b){console.log(d+"properties/uploadPhoto"),b.progress=10,b.upload=f.upload({url:d+"properties/uploadPhoto",file:b}).progress(function(a){b.progress=Math.min(100,parseInt(100*a.loaded/a.total)),b.progressMsg=b.progress}).success(function(c,d,e,f){b.progress=100,b.progressMsg="Success",b.error=!1,console.log("file "+f.file.name+"uploaded. Response: "+c.success),a.property.imagePaths.push({path:c.success}),a.property.imagePaths.length==a.photosToUpload.length&&(console.log("imagepaths ",a.property.imagePaths),console.log("and photostoupload ",a.photosToUpload),console.log("SENDING DATA: ",a.property),a.property.$update({id:a.property.id},function(b){console.log("COMPLETED",b),g.go("showProperty",{propertyId:a.property.id})}))}).error(function(a,c,d,e){b.progress=100,b.progressMsg="Error",b.error=!0})}a.uploadingPhotos=!1,a.map={center:{latitude:0,longitude:0},zoom:16},a.property={},a.photosToUpload=[],a.photosBackup=[],a.property.propertyFacilities=[],a.details={},a.propertyTypes=b.propertyTypes.query(),a.propertyFacilities=b.propertyFacilities.query(function(){console.log(a.propertyFacilities)}),a.fileReaderSupported=null!=window.FileReader&&(null==window.FileAPI||0!=FileAPI.html5),a.neededAddressComponents={locality:"long_name",administrative_area_level_1:"short_name",country:"long_name",postal_code:"long_name",route:"long_name",street_number:"long_name"},a.addressAssembler={locality:"city",administrative_area_level_1:"administrativeArea",country:"country",postal_code:"postalCode"},a.addressComponentsAssembler={route:"street",street_number:"street_number"},a.property=new b.property.get({id:c.propertyId},function(){a.property.userAccount.username!=localStorage.getItem("currentUsername")?g.go("accessDenied"):(a.photosToUpload=a.photosToUpload.concat(a.property.imagePaths),console.log(a.photosToUpload),console.log("GOT IT",a.property),a.map.center.latitude=a.property.latitude,a.map.center.longitude=a.property.longitude,a.marker={id:0,coords:{latitude:a.property.latitude,longitude:a.property.longitude},options:{draggable:!0}},a.address=a.property.address)}),a.$watch("details",function(b){if("undefined"!=typeof b.address_components){for(var c="",d="",e=0;e<b.address_components.length;e++){var f=b.address_components[e].types[0];a.neededAddressComponents[f]&&("street"==a.addressComponentsAssembler[f]?c=b.address_components[e][a.neededAddressComponents[f]]:"street_number"==a.addressComponentsAssembler[f]?d=" "+b.address_components[e][a.neededAddressComponents[f]]:a.property[a.addressAssembler[f]]=b.address_components[e][a.neededAddressComponents[f]])}a.property.address=c+d,a.marker.coords.latitude=b.geometry.location.k,a.marker.coords.longitude=b.geometry.location.D,a.map.center.latitude=b.geometry.location.k,a.map.center.longitude=b.geometry.location.D,a.map.zoom=16,a.property.latitude=b.geometry.location.k,a.property.longitude=b.geometry.location.D}}),a.removePhoto=function(b){var c=a.photosToUpload.indexOf(b);c>-1&&(a.photosToUpload.splice(c,1),a.photosBackup.push(b),console.log("upload:",a.photosToUpload),console.log("backup",a.photosBackup))},a.restorePhoto=function(b){var c=a.photosBackup.indexOf(b);c>-1&&(a.photosBackup.splice(c,1),a.photosToUpload.push(b),console.log("upload:",a.photosToUpload),console.log("backup",a.photosBackup))},a.updateProperty=function(){console.log("updating",a.property.propertyFacilities);for(var b=0;b<a.property.propertyFacilities.length;b++)delete a.property.propertyFacilities[b].atpropertyFacilityId;a.uploadAndSave()},a.$watch("photos",function(b){if(console.log("WORKS?",b),null!=b)for(var c=0;c<b.length;c++)a.errorMsg=null,a.generateThumb(b[c]),a.photosToUpload.push(b[c])}),a.uploadAndSave=function(){if(a.photosToUpload&&a.photosToUpload.length){a.property.imagePaths=[];for(var b=0;b<a.photosToUpload.length;b++)"undefined"==typeof a.photosToUpload[b].path?(a.uploadingPhotos=!0,console.log("UPLOADING",a.photosToUpload[b]),h(a.photosToUpload[b])):a.property.imagePaths.push(a.photosToUpload[b]);a.uploadingPhotos||a.property.$update({id:a.property.id},function(b){console.log("COMPLETED",b),g.go("showProperty",{propertyId:a.property.id})})}},a.generateThumb=function(b){null!=b&&a.fileReaderSupported&&b.type.indexOf("image")>-1&&e(function(){var a=new FileReader;a.readAsDataURL(b),a.onload=function(a){e(function(){b.dataUrl=a.target.result})}})},a.updateButtonDisabled=function(b){return b.$valid&&a.property.propertyFacilities.length>0&&a.photosToUpload.length>0?!1:!0}}]);var searchProperties=angular.module("searchProperties",[]);searchProperties.config(["$stateProvider",function(a){a.state("queryProperties",{url:"/queryProperties/:address/:country/:city/:admArea/:checkIn/:checkOut/:guestNumber",views:{mainView:{templateUrl:"modules/searchProperties/partials/searchProperties.html",controller:"SearchPropertiesCtrl"}},params:{checkIn:"",checkOut:"",guestNumber:""},data:{authorities:[],pageTitle:"Find properties"}})}]),searchProperties.controller("SearchPropertiesCtrl",["$scope","PropertyService","$stateParams","$location","$filter",function(a,b,c,d,e){a.propertyFacilities=b.propertyFacilities.query(),a.propertyTypes=b.propertyTypes.query(),a.pricePerNightOptions=[{id:1,lowerBound:0,upperBound:50},{id:2,lowerBound:50,upperBound:100},{id:3,lowerBound:100,upperBound:150},{id:4,lowerBound:150,upperBound:200},{id:5,lowerBound:250}],a.sorting={propertyFacilities:[],propertyTypes:[],prices:[]};var f=void 0,g=void 0;(""!=c.checkIn||""!=c.checkOut)&&(console.log("ok",c.checkIn),f=moment(c.checkIn,"DD/MM/YYYY")._d,g=moment(c.checkOut,"DD/MM/YYYY")._d),a.beforeRender=function(a,b,c,d,e){for(var f=0;f<b.length;f++){var g=moment(b[f].utcDateValue);moment().diff(g,"days")>0&&(b[f].selectable=!1)}},a.queryToPass={},a.$watch("query.checkIn",function(b){a.queryToPass.checkIn=e("date")(a.query.checkIn,"dd/MM/yyyy")}),a.$watch("query.checkOut",function(b){a.queryToPass.checkOut=e("date")(a.query.checkOut,"dd/MM/yyyy")}),a.neededAddressComponents={locality:"long_name",administrative_area_level_1:"short_name",country:"long_name"},a.addressAssembler={locality:"city",administrative_area_level_1:"administrativeArea",country:"country"},console.log("we got ",c.checkIn,moment(c.checkIn,"DD/MM/yyyy")._d),console.log("and ",c.checkOut,moment(c.checkOut,"DD/MM/yyyy")._d),a.query={address:c.address,country:c.country,city:c.city,administrativeArea:c.admArea,checkIn:f,checkOut:g,guestNumber:parseInt(c.guestNumber)},console.log("what goes to datepicker::",a.query.checkIn),a.details={},a.autoCompleteOptions={watchEnter:!1},a.$watch("details",function(b){if("undefined"!=typeof b.address_components){a.query.locality="",a.query.administrativeArea="",a.query.country="";for(var c=0;c<b.address_components.length;c++){var d=b.address_components[c].types[0];a.neededAddressComponents[d]&&(a.query[a.addressAssembler[d]]=b.address_components[c][a.neededAddressComponents[d]])}}console.log(a.details),console.log("query: ",a.query)}),a.properties=b.property.find(a.query),a.$watch("properties",function(){console.log("WE GOT EM",a.properties)}),a.queryProperties=function(c){var e="/queryProperties/"+a.query.address+"/"+a.query.country+"/"+a.query.city+"/"+a.query.administrativeArea+"/"+encodeURIComponent(moment(a.query.checkIn).format("DD/MM/YYYY"))+"/"+encodeURIComponent(moment(a.query.checkOut).format("DD/MM/YYYY"))+"/"+a.query.guestNumber;d.path(e).replace(),a.properties=b.property.find(a.query)},a.resetQuery=function(){a.query.city="",a.query.administrativeArea="",a.query.country=""}}]);var login=angular.module("login",[]);login.config(["$stateProvider",function(a){a.state("login",{url:"/login",views:{mainView:{templateUrl:"modules/security/partials/login.html",controller:"LoginCtrl"}},data:{authorities:[],pageTitle:"Login"}}).state("accessDenied",{url:"/accessDenied",views:{mainView:{templateUrl:"modules/security/partials/accessDenied.html"}},data:{authorities:[],pageTitle:"Access denied"}})}]),login.controller("LoginCtrl",["$scope","AccountService","$state","$rootScope",function(a,b,c,d){a.login=function(){console.log(a.userAccount),b.login(a.userAccount).then(function(){a.returnToState?c.go(a.returnToState.name,a.returnToStateParams):c.go("home")},function(){a.errorLogIn=!0})}}]);var logout=angular.module("logout",[]);logout.config(["$stateProvider",function(a){a.state("logout",{url:"/logout",views:{mainView:{controller:"LogoutCtrl"}},data:{authorities:["ROLE_USER"]}})}]),logout.controller("LogoutCtrl",["$scope","AccountService","$state","$rootScope",function(a,b,c,d){a.service=new b.logout}]);var register=angular.module("register",[]);register.config(["$stateProvider",function(a){a.state("register",{url:"/register",views:{mainView:{templateUrl:"modules/security/partials/register.html",controller:"RegisterCtrl"}},data:{authorities:[],pageTitle:"Register"}})}]),register.controller("RegisterCtrl",["$scope","AccountService","$state",function(a,b,c){a.userAccount=new b.account,a.register=function(){var d=a.userAccount.password;console.log(a.userAccount),a.userAccount.$save(function(e){a.userAccount.password=d,b.login(a.userAccount).then(function(a){console.log("WTF"),console.log(a),c.go("home")})})},a.checkUsername=function(c){console.log(c),b.account.findByUsername({username:a.userAccount.username},function(){c.username.$setValidity("usernameAvailable",!0)},function(){console.log("ERR"),c.username.$setValidity("usernameAvailable",!1)})}}]);var showProperty=angular.module("showProperty",[]);showProperty.config(["$stateProvider",function(a){a.state("showProperty",{url:"/showProperty/{propertyId}/{checkIn}/{checkOut}/{guestNumber}",views:{mainView:{templateUrl:"modules/showProperty/partials/showProperty.html",controller:"ShowPropertyCtrl"}},params:{checkIn:"",checkOut:"",guestNumber:""},data:{authorities:[],pageTitle:"Show property"}})}]),showProperty.controller("ShowPropertyCtrl",["$scope","PropertyService","$resource","$stateParams","BookingService","$state",function(a,b,c,d,e,f){a.currentUser=localStorage.getItem("currentUsername"),a.map={center:{latitude:0,longitude:0},zoom:16},a.mapOptions={scrollwheel:!1};var g=void 0,h=void 0;(""!=d.checkIn||""!=d.checkOut)&&(console.log("ok",d.checkIn),g=moment(d.checkIn,"DD/MM/YYYY")._d,h=moment(d.checkOut,"DD/MM/YYYY")._d),
console.log(g),a.unavailableDatesBetween=!1,a.booking=new e.booking,a.booking.checkIn=g,a.booking.checkOut=h,a.booking.guestNumber=parseInt(d.guestNumber),a.booking.userAccount={username:a.currentUser},a.booking.property={id:d.propertyId},a.newReview={},a.comment={},a.reviews=new b.reviews.query({id:d.propertyId},function(){console.log("WE GOT DEM REVIEWS",a.reviews)}),a.stars=[1,2,3,4,5],a.canSendReviews=new b.reviews.canSendReviews({propertyId:d.propertyId},function(){console.log("soooo",a.canSendReviews)}),a.reviewToComment=0,a.commentReview=function(b){a.reviewToComment==b?a.reviewToComment=0:a.reviewToComment=b},a.addReview=function(c,e){0==c?(console.log(a.newReview),"undefined"!=typeof a.newReview.stars?b.reviews.save({id:d.propertyId},a.newReview,function(c){a.reviews=new b.reviews.query({id:d.propertyId}),a.newReview={},e.$setPristine(),a.starsRequired=!1}):a.starsRequired=!0):(a.comment.parentReviewId=c,console.log(a.newReview.parentReviewId),b.reviews.save({id:d.propertyId},a.comment,function(c){a.reviews=new b.reviews.query({id:d.propertyId}),a.comment={},a.reviewToComment=0,e.$setPristine()}))},console.log(a.booking),a.property=new b.property.get({id:d.propertyId},function(){a.map.center.latitude=a.property.latitude,a.map.center.longitude=a.property.longitude,a.marker={id:0,coords:{latitude:a.property.latitude,longitude:a.property.longitude},options:{draggable:!1}},console.log(a.property),a.currentIndx=0,a.mainImgUrl=a.property.imagePaths[0].path,a.maxGuests=a.property.guestCount,a.maxLength<a.property.description.length&&(a.showMoreDesc="Show more"),a.maxLength<a.property.rules.length&&(a.showMoreRules="Show more")}),a.setImg=function(b){a.mainImgUrl=b.path,a.currentIndx=a.property.imagePaths.indexOf(b)},a.nextImg=function(){a.setImg(a.currentIndx==a.property.imagePaths.length-1?a.property.imagePaths[0]:a.property.imagePaths[a.currentIndx+1])},a.prevImg=function(){a.setImg(0==a.currentIndx?a.property.imagePaths[a.property.imagePaths.length-1]:a.property.imagePaths[a.currentIndx-1])},a.unavailableDates=new e.unavailableDates.query({id:d.propertyId},function(){console.log(a.unavailableDates)}),a.beforeRender=function(b,c,d,e,f){if(a.unavailableDates.length>0)for(var g=0;g<c.length;g++){var h=moment(c[g].utcDateValue);if(moment().diff(h,"days")<0)for(var i=0;i<a.unavailableDates.length;i++){var j=moment(a.unavailableDates[i].startDate),k=moment(a.unavailableDates[i].endDate);(h.isBetween(j,k,"day")||h.isSame(j,"day")||h.isSame(k,"day"))&&(c[g].selectable=!1)}else c[g].selectable=!1}else console.log("nothing")},a.bookApartment=function(){console.log("CHEC");var b=!1;if(!angular.isUndefined(a.booking.checkOut)&&!angular.isUndefined(a.booking.checkIn)){console.log("OKAY");var c=moment(a.booking.checkIn),d=moment(a.booking.checkOut),e=d.diff(c,"days");if(console.log("DIF",e),e>=a.property.minimumNights)for(var g=0;g<a.unavailableDates.length;g++){var h=moment(a.unavailableDates[g].startDate),i=moment(a.unavailableDates[g].endDate);console.log("LOOP",g),(h.isBetween(a.booking.checkIn,a.booking.checkOut)||i.isBetween(a.booking.checkIn,a.booking.checkOut))&&(console.log("YAY"),b=!0)}else b=!0}b?(a.bookingForm.checkIn.$setValidity("validcheckIn",!1),a.bookingForm.checkOut.$setValidity("validcheckOut",!1),console.log("ERRORS")):(console.log("should not",a.booking),a.booking.$save(),f.go("showMyBookings"))},a.showMoreDesc="",a.showMoreRules="",a.maxLength=100,a.showMoar=function(b){var c="Show more",d="Show less";"desc"==b?a.maxLength<a.property.description.length&&(a.showMoreDesc==c?a.showMoreDesc=d:a.showMoreDesc=c):a.maxLength<a.property.description.length&&(a.showMoreRules==c?a.showMoreRules=d:a.showMoreRules=c)},a.deleteReview=function(c){b.reviews.remove({id:c},function(){console.log("DELETED"),a.reviews=new b.reviews.query({id:d.propertyId})})},a.canComment=function(b){for(var c=0;c<a.reviews.length;c++)if(a.reviews[c].parentReviewId==b)return!1;return!0}}]);var propertyDirective=angular.module("BookingDatesDirective",[]);propertyDirective.directive("checkDatesMatch",function(){var a=function(a,b,c){if("undefined"==typeof b||"undefined"==typeof c)return!0;var d,e;return"checkIn"==a?(d=moment(b,"DD/MM/YYYY"),e=moment(c)):(d=moment(c),e=moment(b,"DD/MM/YYYY")),d.isAfter(e)?!1:!0},b=function(a,b){if(angular.isUndefined(b))return!0;for(var c=moment(a,"DD/MM/YYYY"),d=0;d<b.length;d++){var e=moment(b[d].startDate),f=moment(b[d].endDate);if(c.isBetween(e,f,"day")||c.isSame(e,"day")||c.isSame(f,"day"))return!1;if(c.isBefore(moment(),"day")||c.isSame(moment(),"day"))return!1}return!0};return{require:"ngModel",scope:{unavailableDates:"=checkDate"},link:function(c,d,e,f){f.$parsers.unshift(function(d){return e.$observe("checkDatesMatch",function(b){f.$setValidity("valid"+e.name,a(e.name,d,c.$eval(b)))}),c.$watch("unavailableDates",function(){var g=b(d,c.unavailableDates),h=g&&a(e.name,d,c.$eval(e.checkDatesMatch));f.$setValidity("valid"+e.name,h)},!0),f.$setValidity("valid"+e.name,a(e.name,d,c.$eval(e.checkDatesMatch))),d}),f.$formatters.unshift(function(d){return e.$observe("checkDatesMatch",function(b){f.$setValidity("valid"+e.name,a(e.name,d,c.$eval(b)))}),c.$watch("unavailableDates",function(){var g=b(d,c.unavailableDates),h=g&&a(e.name,d,c.$eval(e.checkDatesMatch));f.$setValidity("valid"+e.name,h)},!0),f.$setValidity("valid"+e.name,a(e.name,d,c.$eval(e.checkDatesMatch))),d})}}}),propertyDirective.directive("filterDate",["$filter",function(a){return{require:"ngModel",link:function(b,c,d,e){e.$formatters.push(function(b){if("undefined"!=typeof b){var c=a("date")(b,"dd/MM/yyyy");return e.$setViewValue(c),e.$render(),c}}),e.$parsers.push(function(a){return moment(a,"DD/MM/YYYY")._d})}}}]),propertyDirective.directive("countBookingPrice",function(){return{scope:{checkIn:"=",checkOut:"=",nightPrice:"="},templateUrl:"shared/directives/partials/bookingPrice.html",link:function(a,b,c){console.log("PLS DUDE",a.nightPrice),a.$watch("checkIn",function(b){if("undefined"!=typeof a.checkIn&&"undefined"!=typeof a.checkOut){var c=moment(a.checkIn),d=moment(a.checkOut),e=d.diff(c,"days"),f=e*a.nightPrice;f>0?(a.totalPrice=e*a.nightPrice,a.nightCount=e):(delete a.totalPrice,delete a.nightCount)}}),a.$watch("checkOut",function(b){if("undefined"!=typeof a.checkIn&&"undefined"!=typeof a.checkOut){var c=moment(a.checkIn),d=moment(a.checkOut),e=d.diff(c,"days"),f=e*a.nightPrice;f>0?(a.totalPrice=e*a.nightPrice,a.nightCount=e):(delete a.totalPrice,delete a.nightCount)}})}}});var propertyDirective=angular.module("BookingStatusDirective",[]);propertyDirective.directive("showBookingStatus",function(){return{restrict:"E",scope:{list:"=",currentStatusId:"="},templateUrl:"shared/directives/partials/showBookingStatus.html",link:function(a){a.$watch("currentStatusId",function(){angular.forEach(a.list,function(b){b.id==a.currentStatusId&&(a.bookingStatus=b.name,a.bookingStatusDesc=b.description)})})}}});var propertyDirective=angular.module("CheckListDirective",[]);propertyDirective.directive("checkList",["$parse",function(a){return{restrict:"A",scope:{list:"=checkList",value:"@"},link:function(a,b,c){var d=function(c){if("undefined"!=typeof a.list){var d=b.prop("checked"),e=a.list.map(function(a){return a.id}).indexOf(a.$eval(a.value).id);d&&-1==e?c?b.prop("checked",!1):a.list.push(a.$eval(a.value)):d||-1==e||(c?b.prop("checked",!0):a.list.splice(e,1))}},e=d.bind(null,!0),f=d.bind(null,!1);b.bind("change",function(){a.$apply(f)}),a.$watch("list",e,!0)}}}]);var propertyDirective=angular.module("DatepickerDirective",[]);propertyDirective.directive("myDatepicker",function(){return{restrict:"E",scope:{unavailableDates:"=",bookedDates:"=",updateUnDates:"&"},templateUrl:"shared/directives/partials/datepicker.html",link:function(a){a.$watchGroup(["unavailableDates","bookedDates"],function(b){for(var c=[],d=0;d<b[1].length;d++)for(var e=moment(b[1][d].startDate),f=moment(b[1][d].endDate);e.isBefore(f,"day")||e.isSame(f,"day");)c.push(e.format("DD/MM/YYYY")),e.add(1,"day");for(var g=[],d=0;d<b[0].length;d++)g.push(new Date(b[0][d].when));$(".datepicker").datepicker({orientation:"top auto",startDate:"0d",datesDisabled:c}).on("changeDate",function(b){a.updateUnDates({dates:b.dates}),$("#datepicker_data_input").val($(".datepicker").datepicker("getFormattedDate"))}),$(".datepicker").datepicker("setDates",g)})}}});var propertyDirective=angular.module("GroupBookingsByDateDirective",[]);propertyDirective.directive("groupBookingsByDate",["$filter",function(a){return{restrict:"E",scope:{bookings:"=",currentBooking:"=",startFrom:"=",limitTo:"=",orderBy:"@"},templateUrl:"shared/directives/partials/groupBookingsByDate.html",link:function(b){b.bookings=a("startFrom")(b.bookings,b.startFrom),b.bookings=a("limitTo")(b.bookings,b.limitTo),b.bookings=a("orderBy")(b.bookings,b.orderBy);for(var c=0;c<b.bookings.length;c++)if(b.bookings[c].bookedDate==b.currentBooking.bookedDate){for(var d=!0,e=moment(b.currentBooking.bookedDate),f=0;c>f;f++){var g=moment(b.bookings[f].bookedDate);if(e.isSame(g,"month")){d=!1;break}}if(d){b.dateToShow=b.currentBooking.bookedDate;break}}}}}]);var propertyDirective=angular.module("ValidateQueryDirective",[]);propertyDirective.directive("validateQuery",function(){var a=function(a){return""!=a&&"undefined"!=typeof a?(console.log("dunno",a),!0):!1};return{require:"ngModel",link:function(b,c,d,e){e.$parsers.unshift(function(b){return d.$observe("validateQuery",function(b){console.log("HUH",a(b)),e.$setValidity("validQuery",a(b))}),b}),e.$formatters.unshift(function(b){return d.$observe("validateQuery",function(b){e.$setValidity("validQuery",a(b))}),b})}}});var propertyFilters=angular.module("SortingFilters",[]);propertyFilters.filter("sortByFacility",function(){return function(a,b){if(!angular.isUndefined(a)&&b.length>0){for(var c=[],d=b.length,e=0;e<a.length;e++){for(var f=0,g=0;g<b.length;g++){for(var h=0;h<a[e].propertyFacilities.length&&(a[e].propertyFacilities[h].id!=b[g].id||(f++,f!=d));h++);if(f==d)break}f==d&&c.push(a[e])}return c}return a}}),propertyFilters.filter("sortByType",function(){return function(a,b){if(!angular.isUndefined(a)&&b.length>0){for(var c=[],d=0;d<a.length;d++){for(var e=!1,f=0;f<b.length;f++)if(a[d].propertyType==b[f].name){e=!0;break}e&&c.push(a[d])}return c}return a}}),propertyFilters.filter("sortByPrice",function(){return function(a,b){if(!angular.isUndefined(a)&&b.length>0){for(var c=[],d=0;d<a.length;d++){for(var e=!1,f=0;f<b.length;f++)if(a[d].pricePerNight>=b[f].lowerBound&&("undefined"==typeof b[f].upperBound||a[d].pricePerNight<=b[f].upperBound)){e=!0;break}e&&c.push(a[d])}return c}return a}}),propertyFilters.filter("sortByYearBooking",function(){return function(a,b){if(!angular.isUndefined(a)&&!angular.isUndefined(b)&&""!=b){for(var c=[],d=0;d<a.length;d++){var e=moment(a[d].bookedDate).year();e==b&&c.push(a[d])}return c}return a}}),propertyFilters.filter("startFrom",function(){return function(a,b){return angular.isUndefined(a)?void 0:a.slice(b)}});var propertyFilters=angular.module("TruncateFilter",[]);propertyFilters.filter("truncate",function(){return function(a,b,c){if(!angular.isUndefined(a)){if("Show more"==c&&a.length>b){for(var d=/\s/,e=0;b>e;e++)if(d.exec(a[b-e])){b-=e;break}var f=a.slice(0,b);return f+="..."}return a}}});var propertyService=angular.module("AccountServiceModule",[]);propertyService.factory("AccountService",["$resource","API_URL","$http","$rootScope","$state","ConversationService","APP_URL",function(a,b,c,d,e,f,g){var h={account:a(b+"accounts/:accountId",{},{findByUsername:{method:"GET",url:b+"accounts/username/:username"}}),login:function(a){return c.post(g+"login","username="+a.username+"&password="+a.password,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(b){localStorage.setItem("currentUsername",a.username),d.currentUsername=localStorage.getItem("currentUsername"),localStorage.setItem("authority",b.data.authority),d.newMsgs=new f.conversation.query({})})},logout:function(){console.log("logout"),c.post(g+"logout",{}).success(function(){localStorage.removeItem("currentUsername"),localStorage.removeItem("authority"),delete d.currentUsername,e.go("home")}).error(function(a){localStorage.removeItem("currentUsername"),localStorage.removeItem("authority"),delete d.currentUsername,e.go("home")})}};return h}]);var propertyService=angular.module("BookingServiceModule",[]);propertyService.factory("BookingService",["$resource","API_URL",function(a,b){var c={booking:a(b+"bookings/:id",{},{myBookings:{method:"GET",isArray:!0,url:b+"bookings/myBookings"},myPropertiesBookings:{method:"GET",isArray:!0,url:b+"bookings/myPropertysBookings/:propertyId"},allMyPropertiesBookings:{method:"GET",isArray:!0,url:b+"bookings/myPropertiesBookings"}}),propertyBookedDays:a(b+"bookings/bookedDaysStatistics/:id/:year",{}),propertyAvgBookingGuestCount:a(b+"bookings/bookingAvgGuestCountStatistics/:id/:year",{}),propertyAvgStars:a(b+"bookings/bookingAvgRatingStatistics/:id/:year",{}),propertyAvgBookingLength:a(b+"bookings/bookingAvgLengthStatistics/:id/:year",{}),bookingsStatuses:a(b+"bookings/bookingStatuses",{},{updateBookingStatus:{method:"GET",url:b+"bookings/bookingStatus/:bookingId/:statusId"}}),unavailableDates:a(b+"bookings/unavailableDates/:id",{}),onlyBookedDays:a(b+"bookings/onlyBookedDates/:id"),onlyUnavailableDays:a(b+"bookings/onlyUnavailableDates/:id",{},{update:{method:"PUT"}})};return c}]);var propertyService=angular.module("ConversationServiceModule",[]);propertyService.factory("ConversationService",["$resource","API_URL",function(a,b){var c={conversation:a(b+"messages/:bookingId",{},{markRead:{method:"GET",url:b+"messages/markRead/:bookingId"}})};return c}]);var httpInterceptor=angular.module("HttpInterceptorService",[]);httpInterceptor.factory("httpErrorResponseInterceptor",["$q","$location",function(a,b){return{response:function(a){return a},responseError:function(c){switch(c.status){case 401:localStorage.removeItem("currentUsername"),localStorage.removeItem("authority"),b.path("/login");break;case 403:b.path("/accessDenied");break;default:console.log("ERROR")}return a.reject(c)}}}]);var propertyService=angular.module("PropertyServiceModule",[]);propertyService.factory("PropertyService",["$resource","API_URL",function(a,b){var c={property:a(b+"properties/:id",{},{find:{method:"POST",isArray:!0,url:b+"properties/search"},findMyProperties:{method:"GET",isArray:!0,url:b+"properties/myProperties/:ownerId"},update:{method:"PUT"}}),propertyTypes:a(b+"properties/propertyTypes",{}),propertyFacilities:a(b+"properties/propertyFacilities",{}),reviews:a(b+"properties/reviews/:id",{},{canSendReviews:{method:"GET",url:b+"bookings/canSendReviews/:propertyId"}})};return c}]);